<?php

namespace Database\Seeders;

use Illuminate\Database\Seeder;
use BezhanSalleh\FilamentShield\Support\Utils;
use Spatie\Permission\PermissionRegistrar;

class ShieldSeeder extends Seeder
{
    public function run(): void
    {
        app()[PermissionRegistrar::class]->forgetCachedPermissions();

        $rolesWithPermissions = '[{"name":"super_admin","guard_name":"web","permissions":["view_dashboard","view_puestos","create_puestos","edit_puestos","delete_puestos","manage_puestos","generate_qr","view_turnos","create_turnos","edit_turnos","delete_turnos","manage_turnos","scan_qr","view_verificaciones","export_verificaciones","view_reportes","export_reportes","view_reportes_equipos","view_bitacora","view_colaboradores","manage_colaboradores","manage_roles","manage_usuarios","view_area","view_any_area","create_area","update_area","restore_area","restore_any_area","replicate_area","reorder_area","delete_area","delete_any_area","force_delete_area","force_delete_any_area","view_bitacora::estado","view_any_bitacora::estado","create_bitacora::estado","update_bitacora::estado","restore_bitacora::estado","restore_any_bitacora::estado","replicate_bitacora::estado","reorder_bitacora::estado","delete_bitacora::estado","delete_any_bitacora::estado","force_delete_bitacora::estado","force_delete_any_bitacora::estado","view_cargo","view_any_cargo","create_cargo","update_cargo","restore_cargo","restore_any_cargo","replicate_cargo","reorder_cargo","delete_cargo","delete_any_cargo","force_delete_cargo","force_delete_any_cargo","view_categoria::local","view_any_categoria::local","create_categoria::local","update_categoria::local","restore_categoria::local","restore_any_categoria::local","replicate_categoria::local","reorder_categoria::local","delete_categoria::local","delete_any_categoria::local","force_delete_categoria::local","force_delete_any_categoria::local","view_categoria::reporte","view_any_categoria::reporte","create_categoria::reporte","update_categoria::reporte","restore_categoria::reporte","restore_any_categoria::reporte","replicate_categoria::reporte","reorder_categoria::reporte","delete_categoria::reporte","delete_any_categoria::reporte","force_delete_categoria::reporte","force_delete_any_categoria::reporte","view_colaborador","view_any_colaborador","create_colaborador","update_colaborador","restore_colaborador","restore_any_colaborador","replicate_colaborador","reorder_colaborador","delete_colaborador","delete_any_colaborador","force_delete_colaborador","force_delete_any_colaborador","view_contratistas","view_any_contratistas","create_contratistas","update_contratistas","restore_contratistas","restore_any_contratistas","replicate_contratistas","reorder_contratistas","delete_contratistas","delete_any_contratistas","force_delete_contratistas","force_delete_any_contratistas","view_departamento","view_any_departamento","create_departamento","update_departamento","restore_departamento","restore_any_departamento","replicate_departamento","reorder_departamento","delete_departamento","delete_any_departamento","force_delete_departamento","force_delete_any_departamento","view_equipo","view_any_equipo","create_equipo","update_equipo","restore_equipo","restore_any_equipo","replicate_equipo","reorder_equipo","delete_equipo","delete_any_equipo","force_delete_equipo","force_delete_any_equipo","view_estado","view_any_estado","create_estado","update_estado","restore_estado","restore_any_estado","replicate_estado","reorder_estado","delete_estado","delete_any_estado","force_delete_estado","force_delete_any_estado","view_estado::civil","view_any_estado::civil","create_estado::civil","update_estado::civil","restore_estado::civil","restore_any_estado::civil","replicate_estado::civil","reorder_estado::civil","delete_estado::civil","delete_any_estado::civil","force_delete_estado::civil","force_delete_any_estado::civil","view_estado::reporte","view_any_estado::reporte","create_estado::reporte","update_estado::reporte","restore_estado::reporte","restore_any_estado::reporte","replicate_estado::reporte","reorder_estado::reporte","delete_estado::reporte","delete_any_estado::reporte","force_delete_estado::reporte","force_delete_any_estado::reporte","view_genero","view_any_genero","create_genero","update_genero","restore_genero","restore_any_genero","replicate_genero","reorder_genero","delete_genero","delete_any_genero","force_delete_genero","force_delete_any_genero","view_grupo::sanguineo","view_any_grupo::sanguineo","create_grupo::sanguineo","update_grupo::sanguineo","restore_grupo::sanguineo","restore_any_grupo::sanguineo","replicate_grupo::sanguineo","reorder_grupo::sanguineo","delete_grupo::sanguineo","delete_any_grupo::sanguineo","force_delete_grupo::sanguineo","force_delete_any_grupo::sanguineo","view_historial::estado::reporte","view_any_historial::estado::reporte","create_historial::estado::reporte","update_historial::estado::reporte","restore_historial::estado::reporte","restore_any_historial::estado::reporte","replicate_historial::estado::reporte","reorder_historial::estado::reporte","delete_historial::estado::reporte","delete_any_historial::estado::reporte","force_delete_historial::estado::reporte","force_delete_any_historial::estado::reporte","view_historial::verificacion","view_any_historial::verificacion","create_historial::verificacion","update_historial::verificacion","restore_historial::verificacion","restore_any_historial::verificacion","replicate_historial::verificacion","reorder_historial::verificacion","delete_historial::verificacion","delete_any_historial::verificacion","force_delete_historial::verificacion","force_delete_any_historial::verificacion","view_local","view_any_local","create_local","update_local","restore_local","restore_any_local","replicate_local","reorder_local","delete_local","delete_any_local","force_delete_local","force_delete_any_local","view_nomenclatura","view_any_nomenclatura","create_nomenclatura","update_nomenclatura","restore_nomenclatura","restore_any_nomenclatura","replicate_nomenclatura","reorder_nomenclatura","delete_nomenclatura","delete_any_nomenclatura","force_delete_nomenclatura","force_delete_any_nomenclatura","view_novedad","view_any_novedad","create_novedad","update_novedad","restore_novedad","restore_any_novedad","replicate_novedad","reorder_novedad","delete_novedad","delete_any_novedad","force_delete_novedad","force_delete_any_novedad","view_permiso","view_any_permiso","create_permiso","update_permiso","restore_permiso","restore_any_permiso","replicate_permiso","reorder_permiso","delete_permiso","delete_any_permiso","force_delete_permiso","force_delete_any_permiso","view_prioridad","view_any_prioridad","create_prioridad","update_prioridad","restore_prioridad","restore_any_prioridad","replicate_prioridad","reorder_prioridad","delete_prioridad","delete_any_prioridad","force_delete_prioridad","force_delete_any_prioridad","view_puesto::seguridad","view_any_puesto::seguridad","create_puesto::seguridad","update_puesto::seguridad","restore_puesto::seguridad","restore_any_puesto::seguridad","replicate_puesto::seguridad","reorder_puesto::seguridad","delete_puesto::seguridad","delete_any_puesto::seguridad","force_delete_puesto::seguridad","force_delete_any_puesto::seguridad","view_registrar::turno","view_any_registrar::turno","create_registrar::turno","update_registrar::turno","restore_registrar::turno","restore_any_registrar::turno","replicate_registrar::turno","reorder_registrar::turno","delete_registrar::turno","delete_any_registrar::turno","force_delete_registrar::turno","force_delete_any_registrar::turno","view_reporte","view_any_reporte","create_reporte","update_reporte","restore_reporte","restore_any_reporte","replicate_reporte","reorder_reporte","delete_reporte","delete_any_reporte","force_delete_reporte","force_delete_any_reporte","view_reporte::tecnico","view_any_reporte::tecnico","create_reporte::tecnico","update_reporte::tecnico","restore_reporte::tecnico","restore_any_reporte::tecnico","replicate_reporte::tecnico","reorder_reporte::tecnico","delete_reporte::tecnico","delete_any_reporte::tecnico","force_delete_reporte::tecnico","force_delete_any_reporte::tecnico","view_tipo::contrato","view_any_tipo::contrato","create_tipo::contrato","update_tipo::contrato","restore_tipo::contrato","restore_any_tipo::contrato","replicate_tipo::contrato","reorder_tipo::contrato","delete_tipo::contrato","delete_any_tipo::contrato","force_delete_tipo::contrato","force_delete_any_tipo::contrato","view_tipo::documento","view_any_tipo::documento","create_tipo::documento","update_tipo::documento","restore_tipo::documento","restore_any_tipo::documento","replicate_tipo::documento","reorder_tipo::documento","delete_tipo::documento","delete_any_tipo::documento","force_delete_tipo::documento","force_delete_any_tipo::documento","view_tipo::equipo","view_any_tipo::equipo","create_tipo::equipo","update_tipo::equipo","restore_tipo::equipo","restore_any_tipo::equipo","replicate_tipo::equipo","reorder_tipo::equipo","delete_tipo::equipo","delete_any_tipo::equipo","force_delete_tipo::equipo","force_delete_any_tipo::equipo","view_tipo::intervencion","view_any_tipo::intervencion","create_tipo::intervencion","update_tipo::intervencion","restore_tipo::intervencion","restore_any_tipo::intervencion","replicate_tipo::intervencion","reorder_tipo::intervencion","delete_tipo::intervencion","delete_any_tipo::intervencion","force_delete_tipo::intervencion","force_delete_any_tipo::intervencion","view_tipo::novedad","view_any_tipo::novedad","create_tipo::novedad","update_tipo::novedad","restore_tipo::novedad","restore_any_tipo::novedad","replicate_tipo::novedad","reorder_tipo::novedad","delete_tipo::novedad","delete_any_tipo::novedad","force_delete_tipo::novedad","force_delete_any_tipo::novedad","view_tipo::permiso","view_any_tipo::permiso","create_tipo::permiso","update_tipo::permiso","restore_tipo::permiso","restore_any_tipo::permiso","replicate_tipo::permiso","reorder_tipo::permiso","delete_tipo::permiso","delete_any_tipo::permiso","force_delete_tipo::permiso","force_delete_any_tipo::permiso","view_tipo::reporte","view_any_tipo::reporte","create_tipo::reporte","update_tipo::reporte","restore_tipo::reporte","restore_any_tipo::reporte","replicate_tipo::reporte","reorder_tipo::reporte","delete_tipo::reporte","delete_any_tipo::reporte","force_delete_tipo::reporte","force_delete_any_tipo::reporte","view_ubicacion","view_any_ubicacion","create_ubicacion","update_ubicacion","restore_ubicacion","restore_any_ubicacion","replicate_ubicacion","reorder_ubicacion","delete_ubicacion","delete_any_ubicacion","force_delete_ubicacion","force_delete_any_ubicacion","view_user","view_any_user","create_user","update_user","restore_user","restore_any_user","replicate_user","reorder_user","delete_user","delete_any_user","force_delete_user","force_delete_any_user","view_verificacion::diaria","view_any_verificacion::diaria","create_verificacion::diaria","update_verificacion::diaria","restore_verificacion::diaria","restore_any_verificacion::diaria","replicate_verificacion::diaria","reorder_verificacion::diaria","delete_verificacion::diaria","delete_any_verificacion::diaria","force_delete_verificacion::diaria","force_delete_any_verificacion::diaria","view_verificacion::turno","view_any_verificacion::turno","create_verificacion::turno","update_verificacion::turno","restore_verificacion::turno","restore_any_verificacion::turno","replicate_verificacion::turno","reorder_verificacion::turno","delete_verificacion::turno","delete_any_verificacion::turno","force_delete_verificacion::turno","force_delete_any_verificacion::turno","view_zona","view_any_zona","create_zona","update_zona","restore_zona","restore_any_zona","replicate_zona","reorder_zona","delete_zona","delete_any_zona","force_delete_zona","force_delete_any_zona"]},{"name":"administrador","guard_name":"web","permissions":["view_dashboard","manage_puestos","manage_turnos","view_verificaciones","view_reportes","export_reportes","view_colaboradores","manage_colaboradores"]},{"name":"supervisor","guard_name":"web","permissions":["view_dashboard","view_puestos","create_turnos","edit_turnos","scan_qr","view_verificaciones","view_reportes_equipos","view_colaboradores"]},{"name":"guardia","guard_name":"web","permissions":["view_turnos","scan_qr"]},{"name":"auditor","guard_name":"web","permissions":["view_verificaciones","view_reportes","export_reportes","view_bitacora"]}]';
        $directPermissions = '[]';

        static::makeRolesWithPermissions($rolesWithPermissions);
        static::makeDirectPermissions($directPermissions);

        $this->command->info('Shield Seeding Completed.');
    }

    protected static function makeRolesWithPermissions(string $rolesWithPermissions): void
    {
        if (! blank($rolePlusPermissions = json_decode($rolesWithPermissions, true))) {
            /** @var Model $roleModel */
            $roleModel = Utils::getRoleModel();
            /** @var Model $permissionModel */
            $permissionModel = Utils::getPermissionModel();

            foreach ($rolePlusPermissions as $rolePlusPermission) {
                $role = $roleModel::firstOrCreate([
                    'name' => $rolePlusPermission['name'],
                    'guard_name' => $rolePlusPermission['guard_name'],
                ]);

                if (! blank($rolePlusPermission['permissions'])) {
                    $permissionModels = collect($rolePlusPermission['permissions'])
                        ->map(fn ($permission) => $permissionModel::firstOrCreate([
                            'name' => $permission,
                            'guard_name' => $rolePlusPermission['guard_name'],
                        ]))
                        ->all();

                    $role->syncPermissions($permissionModels);
                }
            }
        }
    }

    public static function makeDirectPermissions(string $directPermissions): void
    {
        if (! blank($permissions = json_decode($directPermissions, true))) {
            /** @var Model $permissionModel */
            $permissionModel = Utils::getPermissionModel();

            foreach ($permissions as $permission) {
                if ($permissionModel::whereName($permission)->doesntExist()) {
                    $permissionModel::create([
                        'name' => $permission['name'],
                        'guard_name' => $permission['guard_name'],
                    ]);
                }
            }
        }
    }
}
